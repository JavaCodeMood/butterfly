/**
 * @fileoverview 图片上传主题（带图片预览）
 * @author 明河
 **/KISSY.add(function(e,t,n){function s(e){var t=this;s.superclass.constructor.call(t,e)}var r="",i=t.all;return e.extend(s,n,{afterUploaderRender:function(){var e=this,t=e.get("queue");t.on("add",e._addFileHandler,e),t.on("remove",function(){e._changeText()});var n=e.get("button"),r=i(n.get("target")).text();e.set("defaultText",r)},_addFileHandler:function(e){var t=this,n=e.file,r=i(".J_Del_"+n.id);r.data("data-file",n),r.on("click",t._delHandler,t)},_getStatusWrapper:function(e){return e&&e.all(".J_FileStatus")||i("")},_waitingHandler:function(e){var t=this,n=e.uploader,r=n.get("type");if(r=="ajax"){var s=t.get("oPlugin").preview,o=e.file,u=o.id,a=i(".J_Pic_"+u);a.show();var f=new s;f.show(o.data,a)}},_startHandler:function(t){var n=this,r=t.uploader,s=t.index,o=n.get("queue"),u=r.get("type"),a=t.file,f=i(".J_ProgressBar_"+t.id),l=i(".J_Mask_"+t.id);l.show();if(u=="ajax"||u=="flash"){var c=n.get("oPlugin").progressBar,h;c&&(h=new c(f),h.on("change",function(t){t.value==100&&e.later(function(){h.hide(),n._setDisplayMask(!1,a),a.statusWrapper.hide()},500)}),h.render(),n.set("progressBar",h)),o.updateFile(s,{progressBar:h})}},_progressHandler:function(e){var t=e.file,n=e.loaded,r=e.total,i=Math.ceil(n/r*100),s=t.progressBar;if(!s)return!1;s.set("value",i)},_successHandler:function(e){var t=this,n=e.file,r=n.id,s=n.result,o=n.progressBar;s&&t._changeImageSrc(e.id,s),t._changeText();if(!o)return i(".J_ProgressBar_"+r).hide(),t._setDisplayMask(!1,e.file),n.statusWrapper.hide(),!1;o.set("value",100)},_errorHandler:function(t){var n=this,r=t.msg,s=t.id,o=n.get("queue");e.log(r);if(t.rule=="max")return!1;i(".J_ErrorMsg_"+s).html("\u4e0a\u4f20\u5931\u8d25"),e.later(function(){alert(r),o.remove(s)},1e3)},_setDisplayMask:function(e,t){if(!t)return!1;var n=i(".J_Mask_"+t.id);n[e&&"show"||"hide"](),e?n.show():n.hide()},_delHandler:function(e){var t=this,n=t.get("uploader"),r=t.get("queue"),s=i(e.target).data("data-file"),o=r.getFileIndex(s.id),u=s.status;(u=="start"||u=="progress")&&n.cancel(o)},getFilesLen:function(e){e||(e="success");var t=this,n=t.get("queue"),r=n.getFiles(e);return r.length},_changeImageSrc:function(t,n){var s=n.data,o,u=i(".J_Pic_"+t);if(!e.isObject(s))return!1;o=s.sUrl||s.url,u.attr("src")==r&&(u.show(),u.attr("src",o))},_changeText:function(){var t=this,n=t.getFilesLen(),r=t.get("auth"),i=t.get("button"),s=i.get("target").children("span"),o=t.get("maxText"),u=t.get("defaultText");if(!r)return!1;var a=r.get("rules"),f=a.max;if(!f)return!1;f[0]==n?s.text(e.substitute(o,{max:f[0]})):s.text(u)}},{ATTRS:{name:{value:"refundUploader"},cssUrl:{value:"gallery/form/1.3/uploader/themes/refundUploader/style.css"},fileTpl:{value:'<li id="queue-file-{id}" class="g-u" data-name="{name}"><div class="pic-wrapper"><div class="pic"><span><img class="J_Pic_{id}" src="" /></span></div><div class=" J_Mask_{id} pic-mask"></div><div class="status-wrapper J_FileStatus"><div class="status waiting-status"><p>\u7b49\u5f85\u4e0a\u4f20</p></div><div class="status start-status progress-status success-status"><div class="J_ProgressBar_{id}"></div><div>\u4e0a\u4f20\u4e2d</div></div><div class="status error-status"><p class="J_ErrorMsg_{id}">\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\uff01</p></div></div></div><div><a class="J_Del_{id} del-pic" href="#">\u5220\u9664</a></div></li>'},plugins:{value:["progressBar","preview"]},defaultText:{value:r},maxText:{value:"\u60a8\u5df2\u4e0a\u4f20\u6ee1{max}\u5f20\u56fe\u7247"}}}),s},{requires:["node","../../theme"]});